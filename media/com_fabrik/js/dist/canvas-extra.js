/*! Fabrik */
!function(){CanvasRenderingContext2D.prototype.__defineGetter__("width",function(){return this.canvas.width}),CanvasRenderingContext2D.prototype.__defineGetter__("height",function(){return this.canvas.height}),CanvasRenderingContext2D.prototype.blackAndWhite=function(){for(var a=this.getImageData(0,0,this.width,this.height),b=0;b<a.data.length;b+=4){var c=a.data[b+0],d=a.data[b+1],e=a.data[b+2],f=c+d+e;f/=3,a.data[b+0]=f,a.data[b+1]=f,a.data[b+2]=f}this.putImageData(a,0,0)},CanvasRenderingContext2D.prototype.flipVertically=function(){this.save(),this.scale(1,-1),this.translate(0,-this.height),this.drawImage(this.canvas,0,0),this.restore()},CanvasRenderingContext2D.prototype.flipHorizontally=function(){this.save(),this.scale(-1,1),this.translate(-this.width,0),this.drawImage(this.canvas,0,0),this.restore()},CanvasRenderingContext2D.prototype.turn=function(a){var b=document.createElement("canvas");b.width=this.width,b.height=this.height,b.style.display="none",document.body.appendChild(b),b.getContext("2d").drawImage(this.canvas,0,0),this.canvas.width=b.height,this.canvas.height=b.width,this.save(),a?this.translate(this.width,0):this.translate(0,this.height);var c=Math.PI/2;a||(c*=-1),this.rotate(c),this.drawImage(b,0,0),this.restore(),document.body.removeChild(b)},CanvasRenderingContext2D.prototype.resize=function(a){var b=document.createElement("canvas");b.width=this.width,b.height=this.height,b.style.display="none",document.body.appendChild(b),b.getContext("2d").drawImage(this.canvas,0,0),this.canvas.width*=a,this.canvas.height*=a,this.save(),this.scale(a,a),this.drawImage(b,0,0),document.body.removeChild(b),this.restore()},CanvasRenderingContext2D.prototype.isPortrait=function(){return this.width<this.height},CanvasRenderingContext2D.prototype._urlDropped=function(a,b,c,d){var e=this,f=document.createElement("img");f.style.display="none",f.addEventListener("load",function(){var a,g=1,h=1;f.width>e.width/3&&(g=e.width/3/f.width),f.height>e.height/3&&(h=e.height/3/f.height),a=Math.min(g,h),e.save(),e.translate(b-f.width*a/2,c-f.height*a/2),e.scale(a,a),e.drawImage(f,0,0),d&&(e.strokeStyle="white",e.lineWidth=5/a,e.strokeRect(0,0,f.width,f.height)),e.restore(),document.body.removeChild(f)},!0),f.src=a,document.body.appendChild(f)},CanvasRenderingContext2D.prototype.initDnD=function(){var a=this;this.canvas.addEventListener("dragover",function(a){a.preventDefault()},!0),this.canvas.addEventListener("drop",function(b){b.preventDefault();var c=b.dataTransfer,d=b.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,e=b.clientY+document.body.scrollTop+document.documentElement.scrollTop,f=d-a.canvas.offsetLeft-a.canvas.parentNode.offsetLeft,g=e-a.canvas.offsetTop-a.canvas.parentNode.offsetTop,h=c.files;if(0===h.length){var i="application/x-moz-file-promise-url";c.types.contains(i)&&a._urlDropped(c.getData(i),f,g,!1)}else{var j=h[0],k=new FileReader;k.onload=function(b){a._urlDropped(b.target.result,f,g,!0)},k.readAsDataURL(j)}},!0)},CanvasRenderingContext2D.prototype.poster=function(a){var b=Math.min(this.width,this.height);b/=10,this.fillStyle="black",this.fillRect(0,0,this.width,b),this.fillRect(0,this.height-2*b,this.width,2*b),this.fillRect(0,0,b,this.height),this.fillRect(this.width-b,0,b,this.height),this.strokeStyle="white";var c=5;this.strokeRect(b-c,b-c,this.width-2*b+2*c,this.height-3*b+2*c),this.fillStyle="white",this.textAlign="center",this.textBaseline="middle",this.font=b+"px marketing",this.fillText(a,this.width/2,this.height-b,this.width)},CanvasRenderingContext2D.prototype.initCrop=function(){isMobile?this.initCrop_mobile():this.initCrop_desktop()},CanvasRenderingContext2D.prototype.initCrop_mobile=function(){function a(e){c=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,d=e.clientY+document.body.scrollTop+document.documentElement.scrollTop,f.removeEventListener("click",a,!0),f.addEventListener("click",b,!0)}function b(a){f.removeEventListener("click",b,!0);var g=a.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,h=a.clientY+document.body.scrollTop+document.documentElement.scrollTop,i=g-c,j=h-d;g=c,h=d,0>i&&(g+=i,i*=-1),0>j&&(h+=j,j*=-1),g-=f.offsetLeft+f.parentNode.offsetLeft,h-=f.offsetTop+f.parentNode.offsetTop,e.crop(g,h,i,j)}var c,d,e=this,f=this.canvas;f.addEventListener("click",a,!0)},CanvasRenderingContext2D.prototype.initCrop_desktop=function(){function a(a){e=a.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,f=a.clientY+document.body.scrollTop+document.documentElement.scrollTop,h.addEventListener("mousemove",c,!0)}function b(){h.removeEventListener("mousemove",c,!0),h.removeEventListener("mousedown",a,!0),h.removeEventListener("mouseup",b,!0);var e=d.offsetLeft-h.offsetLeft-h.parentNode.offsetLeft,f=d.offsetTop-h.offsetTop-h.parentNode.offsetTop,i=d.offsetWidth,j=d.offsetHeight;document.body.removeChild(d),g.crop(e,f,i,j)}function c(a){var b=a.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,c=a.clientY+document.body.scrollTop+document.documentElement.scrollTop,g=e,h=f,i=b-e,j=c-f;0>i&&(g+=i,i*=-1),0>j&&(h+=j,j*=-1),d.style.display="block",d.style.left=g+"px",d.style.top=h+"px",d.style.width=i+"px",d.style.height=j+"px"}var d=document.createElement("div");d.id="cropbox",d.style.display="none",document.body.appendChild(d);var e,f,g=this,h=this.canvas;h.addEventListener("mousedown",a,!0),h.addEventListener("mouseup",b,!0)},CanvasRenderingContext2D.prototype.crop=function(a,b,c,d){var e=document.createElement("canvas");e.width=this.width,e.height=this.height,e.style.display="none",document.body.appendChild(e),e.getContext("2d").drawImage(this.canvas,0,0),this.canvas.width=c,this.canvas.height=d,this.save(),this.drawImage(e,-a,-b),this.restore(),document.body.removeChild(e)}}();